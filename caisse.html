<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caisse & Cuisine Pizza djoudi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
      
      body { 
        font-family: 'Inter', sans-serif; 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      
      .glass-morphism {
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.18);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      }
      
      .glass-dark {
        background: rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .pizza-gradient { 
        background: linear-gradient(135deg, #ff6b6b, #ee5a24, #ff9ff3);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: gradientShift 3s ease-in-out infinite;
      }
      
      @keyframes gradientShift {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
      }
      
      .neon-glow {
        box-shadow: 0 0 20px rgba(139, 69, 19, 0.3);
        transition: all 0.3s ease;
      }
      
      .neon-glow:hover {
        box-shadow: 0 0 30px rgba(139, 69, 19, 0.6);
        transform: translateY(-2px);
      }
      
      .pulse-button {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
      }
      
      .slide-in {
        animation: slideIn 0.5s ease-out;
      }
      
      @keyframes slideIn {
        from { opacity: 0; transform: translateX(-20px); }
        to { opacity: 1; transform: translateX(0); }
      }
      
      .status-indicator {
        position: relative;
      }
      
      .status-indicator::before {
        content: '';
        position: absolute;
        width: 8px;
        height: 8px;
        background: #10b981;
        border-radius: 50%;
        top: 50%;
        left: -15px;
        transform: translateY(-50%);
        animation: blink 2s infinite;
      }
      
      @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0.3; }
      }
      
      .hidden { display: none !important; }
      
      .menu-button {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }
      
      .menu-button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transition: left 0.5s;
      }
      
      .menu-button:hover::before {
        left: 100%;
      }
      
      .order-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
      }
      
      .order-card:hover {
        transform: scale(1.02);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }

      .border-red-600 { border-color: #dc2626 !important; }
      .border-orange-500 { border-color: #f97316 !important; }
      .border-blue-500 { border-color: #3b82f6 !important; }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, updateDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBwJumnHS5K89DMtNwhB9tE8JFIITD2mPQ",
            authDomain: "pizza-djoudi.firebaseapp.com",
            projectId: "pizza-djoudi",
            storageBucket: "pizza-djoudi.firebasestorage.app",
            messagingSenderId: "902722769032",
            appId: "1:902722769032:web:696ef1cd7fbcd9f2bc8f3d",
            measurementId: "G-WZH035L3YE"
        };
        
        const appId = 'default-app-id';
        const COLLECTION_MEMBRES = () => `artifacts/${appId}/public/data/membres`; 
        const COLLECTION_COMMANDES = () => `artifacts/${appId}/public/data/commandes_en_cours`;
        const COLLECTION_CARTES = () => `artifacts/${appId}/public/data/commandes_cartes_prepayees`;
        
        const AFFILIATE_KEY = 'sup_afk_Qt0taZ0hzcl2I8ExqLBHjLC84KE5jmNB'; 

        const TIME_THRESHOLDS = {
            URGENT: 10 * 60 * 1000,
            HIGH: 5 * 60 * 1000,
        };
        const DELIVERY_COLOR = 'border-blue-500'; 

        let app, db, auth, userId = 'unknown', currentClientDoc = null;
        let currentCart = []; 
        let commandesEnCoursMap = new Map();
        let cartesEnAttenteMap = new Map();
        let searchQuery = '';
        
        let currentPayments = [];
        let currentDiscountPercentage = 0;
        let currentPromoCode = '';
        let totalAfterDiscountGlobal = 0;

        const menu = [
            { name: "SAUMON", price: 15.00, icon: "üç£" }, 
            { name: "POULET", price: 15.00, icon: "üçó" },
            { name: "VIANDE HACH√âE", price: 15.00, icon: "ü•©" }, 
            { name: "THON", price: 15.00, icon: "üêü" },
            { name: "COCA", price: 2.50, icon: "ü•§" },
            { name: "OASIS", price: 2.50, icon: "üßÉ" }
        ];

        const PAYMENT_METHODS = [
            { type: 'Carte', icon: 'üí≥' },
            { type: 'Especes', icon: 'üíµ' },
            { type: 'TicketResto', icon: 'üé´' },
        ];
        
        function isOpened() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const OPENING_HOUR = 11; 
            const OPENING_MINUTE = 30;
            const CLOSING_HOUR = 21; 
            const CLOSING_MINUTE = 0;

            const OPEN_TIME = new Date(today.getFullYear(), today.getMonth(), today.getDate(), OPENING_HOUR, OPENING_MINUTE, 0);
            const CLOSE_TIME = new Date(today.getFullYear(), today.getMonth(), today.getDate(), CLOSING_HOUR, CLOSING_MINUTE, 0);

            return now >= OPEN_TIME && now < CLOSE_TIME;
        }

        function showMessageModal(title, message) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            document.getElementById('message-modal').classList.remove('hidden');
        }
        
        function showConfirmModal(title, message) {
            return new Promise((resolve) => {
                document.getElementById('confirm-title').innerText = title;
                document.getElementById('confirm-message').innerText = message;
                document.getElementById('confirm-modal').classList.remove('hidden');
                document.getElementById('confirm-yes-btn').onclick = () => { resolve(true); document.getElementById('confirm-modal').classList.add('hidden'); };
                document.getElementById('confirm-no-btn').onclick = () => { resolve(false); document.getElementById('confirm-modal').classList.add('hidden'); };
            });
        }

        // --- FONCTION DE PAIEMENT ---
        function showPaymentConfirmationModal(total, paymentType, totalRemaining) {
            return new Promise((resolve) => {
                const modal = document.getElementById('payment-modal');
                const titleElement = document.getElementById('payment-title');
                const contentElement = document.getElementById('payment-content');
                const amountToPay = parseFloat(totalRemaining);

                // Nettoyage des anciens boutons
                const oldBtn = document.getElementById('payment-confirm');
                if(oldBtn) { oldBtn.replaceWith(oldBtn.cloneNode(true)); }

                if (paymentType === 'Especes') {
                    titleElement.innerHTML = 'üíµ Paiement Esp√®ces';
                    contentElement.innerHTML = `
                        <div class="text-center mb-6">
                            <div class="text-3xl font-bold text-green-600 mb-2">√Ä encaisser: ${amountToPay.toFixed(2)}‚Ç¨</div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 font-bold mb-2">Montant re√ßu du client:</label>
                            <input type="number" id="montant-recu" step="0.01" value="${amountToPay.toFixed(2)}" 
                                   class="w-full p-4 border rounded-xl text-xl text-center focus:ring-2 focus:ring-green-500 focus:border-green-500 text-black">
                        </div>
                        <div id="rendu-info" class="text-center mb-6 p-4 bg-gray-100 rounded-xl">
                            <div class="text-lg font-bold text-blue-600">√Ä rendre:</div>
                            <div id="montant-rendu" class="text-2xl font-bold text-blue-800">0.00‚Ç¨</div>
                        </div>
                        <div class="flex space-x-3">
                            <button id="payment-cancel-btn" class="flex-1 bg-gray-300 hover:bg-gray-400 py-3 rounded-xl font-bold transition-all text-black">Annuler</button>
                            <button id="payment-confirm-btn" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 rounded-xl font-bold hover:shadow-lg transition-all">Confirmer</button>
                        </div>
                    `;
                    
                    const montantInput = document.getElementById('montant-recu');
                    const montantRendu = document.getElementById('montant-rendu');
                    
                    montantInput.oninput = () => {
                        let val = montantInput.value.replace(',', '.'); 
                        const recu = parseFloat(val) || 0;
                        const rendu = recu - amountToPay;
                        if (rendu >= 0) {
                            montantRendu.textContent = rendu.toFixed(2) + '‚Ç¨';
                        } else {
                            montantRendu.textContent = "Manque " + Math.abs(rendu).toFixed(2) + '‚Ç¨';
                        }
                    };
                    
                    setTimeout(() => montantInput.select(), 100);
                    
                } else {
                    const title = paymentType === 'Carte' ? 'üí≥ Paiement Carte (Tap to Pay)' : 'üé´ Paiement TR';
                    titleElement.innerHTML = title;
                    let contentHTML = `<div class="text-center mb-6"><div class="text-3xl font-bold text-blue-600 mb-4">Montant: ${amountToPay.toFixed(2)}‚Ç¨</div>`;

                    if (paymentType === 'Carte') {
                        const urlSumUp = `sumupmerchant://pay/1.0?amount=${amountToPay.toFixed(2)}&currency=EUR&title=${encodeURIComponent('Commande Pizza djoudi')}&affiliate-key=${AFFILIATE_KEY}`;
                        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(urlSumUp)}`;
                        contentHTML += `
                            <div class="bg-blue-50 p-6 rounded-xl border-2 border-blue-200">
                                <div class="flex justify-center"><img src="${qrCodeUrl}" alt="QR Code" class="rounded-lg shadow-md"/></div>
                                <div class="text-sm text-gray-600 mt-4">Scannez pour payer via SumUp</div>
                            </div>`;
                    } else {
                        contentHTML += `<div class="bg-blue-50 p-6 rounded-xl border-2 border-blue-200 mt-4"><div class="text-6xl mb-4">üé´</div><div>Valider le ticket resto.</div></div>`;
                    }
                    
                    contentHTML += `</div>
                        <div class="flex flex-col space-y-2">
                            <button id="payment-confirm-btn" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 rounded-xl font-bold hover:shadow-lg">‚úÖ Confirmer Paiement</button>
                            <button id="payment-cancel-btn" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-bold">‚ùå Annuler</button>
                        </div>`;
                    contentElement.innerHTML = contentHTML;
                }
                
                modal.classList.remove('hidden');
                
                setTimeout(() => {
                    const confirmBtn = document.getElementById('payment-confirm-btn');
                    const cancelBtn = document.getElementById('payment-cancel-btn');

                    if(confirmBtn) confirmBtn.onclick = () => {
                        modal.classList.add('hidden');
                        let recuAmount = amountToPay;
                        if (paymentType === 'Especes') {
                            const inputVal = document.getElementById('montant-recu').value.replace(',', '.');
                            recuAmount = parseFloat(inputVal) || amountToPay;
                        }
                        resolve({ confirmed: true, amount: amountToPay, received: recuAmount }); 
                    };
                    
                    if(cancelBtn) cancelBtn.onclick = () => {
                        modal.classList.add('hidden');
                        resolve({ confirmed: false }); 
                    };
                }, 100);
            });
        }
        
        window.removePayment = (index) => {
            currentPayments.splice(index, 1);
            updateSplitPaymentModalDisplay(document.getElementById('split-payment-modal').dataset.total);
        };

        function updateSplitPaymentModalDisplay(total) {
            const totalFloat = parseFloat(total);
            const remainingSpan = document.getElementById('split-remaining-amount');
            const list = document.getElementById('split-payments-list');
            const finalizeBtn = document.getElementById('split-finalize-btn');

            const paid = currentPayments.reduce((sum, p) => sum + p.amount, 0);
            const remaining = Math.max(0, totalFloat - paid); 

            remainingSpan.textContent = remaining.toFixed(2);
            remainingSpan.classList.toggle('text-red-500', remaining > 0.01);
            remainingSpan.classList.toggle('text-green-500', remaining <= 0.01);
            
            // Le bouton finaliser ne s'active que si le reste est ~0
            finalizeBtn.disabled = remaining > 0.01;

            list.innerHTML = currentPayments.map((p, index) => `
                <li class="flex justify-between items-center py-2 px-3 bg-white bg-opacity-20 rounded-lg mb-2">
                    <span class="text-white font-medium">${p.icon} ${p.type}</span>
                    <div class="flex items-center space-x-3">
                        <span class="text-white font-bold">${p.amount.toFixed(2)}‚Ç¨</span>
                        <button onclick="window.removePayment(${index})" class="text-white bg-red-500 w-6 h-6 rounded-full flex items-center justify-center font-bold text-sm">‚úï</button>
                    </div>
                </li>
            `).join('');
            
            // Mise √† jour automatique du champ montant
            const amountInput = document.getElementById('split-payment-amount');
            if (amountInput && remaining > 0) {
                amountInput.value = remaining.toFixed(2);
            }
        }

        window.openSplitPaymentModal = (total) => {
            currentPayments = [];
            document.getElementById('split-payment-modal').dataset.total = total.toFixed(2);
            document.getElementById('split-payment-modal').classList.remove('hidden');
            document.getElementById('split-total-amount').textContent = total.toFixed(2);
            updateSplitPaymentModalDisplay(total.toFixed(2));
        };
        
        window.addSplitPayment = async () => {
            const total = parseFloat(document.getElementById('split-payment-modal').dataset.total);
            const paid = currentPayments.reduce((sum, p) => sum + p.amount, 0);
            const remaining = Math.round((total - paid) * 100) / 100;
            
            const type = document.getElementById('split-payment-type').value;
            const amountInput = document.getElementById('split-payment-amount');
            
            let val = amountInput.value.replace(',', '.');
            let amount = parseFloat(val) || 0;
            
            if (amount <= 0) amount = remaining;
            
            if (amount <= 0.001) {
                showMessageModal("Attention", "Le montant doit √™tre sup√©rieur √† 0.");
                return;
            }
            if (amount > remaining + 0.01) {
                showMessageModal("Erreur", `Le montant (${amount}‚Ç¨) est sup√©rieur au reste √† payer (${remaining.toFixed(2)}‚Ç¨).`);
                return;
            }
            
            const paymentMethod = PAYMENT_METHODS.find(p => p.type === type);
            if (!paymentMethod) return;
            
            const result = await showPaymentConfirmationModal(total, type, amount);
            
            if (result.confirmed) {
                currentPayments.push({ 
                    type: type, 
                    amount: result.amount, 
                    icon: paymentMethod.icon, 
                    received: result.received 
                });
                updateSplitPaymentModalDisplay(total);
            }
        };

        window.finalizeSplitPayment = async (docId) => {
            const total = parseFloat(document.getElementById('split-payment-modal').dataset.total);
            const paid = currentPayments.reduce((sum, p) => sum + p.amount, 0);
            
            if (Math.abs(total - paid) > 0.01) {
                showMessageModal("Erreur", "Le total pay√© ne correspond pas au total de la commande.");
                return;
            }
            
            document.getElementById('split-payment-modal').classList.add('hidden');
            await encaissementFinal(docId, currentPayments);
        };

        window.closeSplitPaymentModal = () => {
            document.getElementById('split-payment-modal').classList.add('hidden');
            currentPayments = [];
        };

        window.updateOrderStatus = async (docId, newStatus) => {
            const docRef = doc(db, COLLECTION_COMMANDES(), docId);
            const confirm = await showConfirmModal("Changement de Statut", `Confirmez le passage de la commande au statut: ${newStatus}?`);
            if (confirm) {
                try {
                    await updateDoc(docRef, { statut: newStatus, date_statut_update: serverTimestamp() });
                    showMessageModal("Succ√®s ‚úÖ", `Statut de la commande #${docId.substring(0, 8)} mis √† jour √† ${newStatus}.`);
                } catch(e) {
                    console.error("Erreur mise √† jour statut: ", e);
                    showMessageModal("Erreur ‚ùå", "Impossible de mettre √† jour le statut.");
                }
            }
        };

        async function encaissementFinal(docId, payments) {
            if (payments.length === 0) return;
            try {
                const paymentSummary = payments.map(p => `${p.type}: ${p.amount.toFixed(2)}‚Ç¨`).join(' / ');
                const mainPaymentType = payments.length === 1 ? payments[0].type : 'Partiel';
                
                await updateDoc(doc(db, COLLECTION_COMMANDES(), docId), {
                    statut: 'PAYEE',
                    paiement: mainPaymentType,
                    paiements: payments,
                    paiement_summary: paymentSummary,
                    date_paiement: serverTimestamp()
                });
                
                showMessageModal("Succ√®s ‚úÖ", "Commande encaiss√©e avec succ√®s !");
            } catch(e) {
                console.error("Erreur encaissement: ", e);
                showMessageModal("Erreur ‚ùå", "Impossible d'encaisser la commande. " + e.message);
            }
        }
        
        window.encaisserCommande = async (docId, total) => {
            currentPayments = [];
            const confirm = await showConfirmModal("Encaissement", `Encaisser la commande pour un montant de ${total.toFixed(2)}‚Ç¨?`);
            if (!confirm) return;

            document.getElementById('split-payment-modal').dataset.orderid = docId;
            document.getElementById('split-payment-modal').dataset.source = 'web_order';
            window.openSplitPaymentModal(total);
        };
        
        window.generateTicketPDF = async (docId) => {
            try {
                const docRef = doc(db, COLLECTION_COMMANDES(), docId);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) { showMessageModal("Erreur", "Commande introuvable."); return; }
                const orderData = docSnap.data();
                
                const articlesList = orderData.articles || [];
                let articlesText = articlesList.map(item => `${item.quantity}x ${item.name} - ${(item.total_ligne || item.price * item.quantity).toFixed(2)}‚Ç¨` ).join('\n');
                
                if (orderData.remise_pourcentage > 0) {
                     const remiseAmount = orderData.total_avant_remise - orderData.total;
                     articlesText += `\nRemise ${orderData.remise_pourcentage}% (${orderData.code_promo}) : -${remiseAmount.toFixed(2)}‚Ç¨`;
                }
                
                let livraisonInfo = '';
                if (orderData.type_commande === 'LIVRAISON' && orderData.adresse_livraison) {
                    livraisonInfo = `\nLIVRAISON √†: ${orderData.adresse_livraison}`;
                    if (orderData.frais_livraison > 0) {
                        livraisonInfo += `\nFrais: ${orderData.frais_livraison.toFixed(2)}‚Ç¨`;
                    }
                } else if (orderData.date_retrait && orderData.heure_retrait) {
                     livraisonInfo = `\nRETRAIT: ${orderData.date_retrait} √† ${orderData.heure_retrait}`;
                }

                const ticketContent = `
                    PIZZA DJOUDI
                    19 rue Fran√ßois Plasson
                    -------------------------
                    COMMANDE #${orderData.numero_commande}
                    Client: ${orderData.client_prenom} ${orderData.client_nom}
                    T√©l: ${orderData.client_telephone}
                    ${livraisonInfo} 
                    -------------------------
                    ${articlesText}
                    -------------------------
                    TOTAL PAY√â: ${orderData.total.toFixed(2)}‚Ç¨
                    Paiement: ${orderData.paiement_summary || orderData.paiement || 'N/A'}
                    ${new Date(orderData.date_paiement?.toDate()).toLocaleString('fr-FR') || ''}
                `;
                
                document.getElementById('ticket-details').innerText = ticketContent;
                document.getElementById('qrcode-numero').innerText = orderData.numero_commande;
                const qrCodeUrl = generateQRTicket(orderData);
                document.getElementById('ticket-qr-image').src = qrCodeUrl;
                document.getElementById('ticket-modal').classList.remove('hidden');
                
            } catch (e) {
                console.error("Erreur g√©n√©ration ticket: ", e);
                showMessageModal("Erreur ‚ùå", "Impossible de g√©n√©rer le ticket.");
            }
        };

        window.closeTicketModal = () => { document.getElementById('ticket-modal').classList.add('hidden'); };
        window.downloadTicket = () => {
            const ticketContent = document.getElementById('ticket-details').innerText;
            const blob = new Blob([ticketContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ticket_commande_${document.getElementById('qrcode-numero').innerText}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };
        
        function handlePromoCode() {
            const promoInput = document.getElementById('promo-code-input');
            const code = promoInput.value.trim().toUpperCase();

            if (code === 'DJOUDI20') {
                currentDiscountPercentage = 20;
                currentPromoCode = code;
                showMessageModal("Succ√®s üéâ", `Le code promo "${code}" a √©t√© appliqu√© (-20%) !`);
            } else if (code === '') {
                currentDiscountPercentage = 0;
                currentPromoCode = '';
                showMessageModal("Remise Annul√©e", "Le code promo a √©t√© retir√©.");
            } else {
                currentDiscountPercentage = 0;
                currentPromoCode = '';
                showMessageModal("Erreur ‚ùå", `Le code promo "${code}" est invalide.`);
            }
            updateCaisseCartDisplay();
        }

        function generateQRTicket(orderData) {
            const articlesForTicket = orderData.articles.map(item => ({ name: `${item.quantity}x ${item.name}`, price: item.total_ligne }));
            
            if (orderData.remise_pourcentage > 0) {
                 articlesForTicket.push({ name: `Remise ${orderData.remise_pourcentage}% (${orderData.code_promo})`, price: -(orderData.total_avant_remise - orderData.total) });
            }
            
            let livraisonQR = '';
            if (orderData.type_commande === 'LIVRAISON') {
                livraisonQR = `| Type: Livraison | Adresse: ${orderData.adresse_livraison}`;
            }

            const paymentDetails = orderData.paiement_summary ? `Mode(s): ${orderData.paiement_summary}\n` : `Mode: ${orderData.paiement}\n`;
            const ticketData = {
                numero: orderData.numero_commande,
                total: orderData.total,
                articles: articlesForTicket,
                timestamp: new Date().toLocaleString('fr-FR'),
                restaurant: "Pizza djoudi",
                paiement_details: paymentDetails,
                livraison: livraisonQR
            };
            
            const ticketText = JSON.stringify(ticketData, null, 2);
            return `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(ticketText)}`;
        }

        function updateCaisseCartDisplay() {
            const cartList = document.getElementById('caisse-cart-list');
            const cartTotal = document.getElementById('caisse-cart-total');
            const totalBeforeDiscountElement = document.getElementById('caisse-total-before-discount');
            const discountInfoElement = document.getElementById('caisse-discount-info');
            const finalizeBtn = document.getElementById('caisse-finalize-btn');
            
            let totalBeforeDiscount = currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let discountAmount = totalBeforeDiscount * (currentDiscountPercentage / 100);
            totalAfterDiscountGlobal = totalBeforeDiscount - discountAmount;

            cartList.innerHTML = currentCart.map(item => `
                <li class="flex justify-between items-center py-2 px-3 bg-white bg-opacity-20 rounded-lg mb-2 slide-in">
                    <span class="text-white font-medium">${item.icon} ${item.name}</span>
                    <div class="flex items-center space-x-3">
                        <button onclick="window.removeCaisseItemQuantity('${item.name}')" class="text-white hover:text-gray-200 font-bold text-lg transition-colors bg-red-500 w-6 h-6 rounded-full flex items-center justify-center">-</button>
                        <span class="text-white font-bold text-lg">${item.quantity}</span>
                        <button onclick="window.addCaisseItem('${item.name}')" class="text-white hover:text-gray-200 font-bold text-lg transition-colors bg-green-500 w-6 h-6 rounded-full flex items-center justify-center">+</button>
                        <span class="text-white ml-3 font-semibold w-16 text-right">${(item.price * item.quantity).toFixed(2)}‚Ç¨</span>
                    </div>
                </li>
            ` ).join('');

            if (currentDiscountPercentage > 0) {
                totalBeforeDiscountElement.textContent = totalBeforeDiscount.toFixed(2) + '‚Ç¨';
                totalBeforeDiscountElement.classList.remove('hidden');
                discountInfoElement.innerHTML = `
                    <div class="text-red-300 font-semibold mb-2">Code Promo ${currentPromoCode}: -${discountAmount.toFixed(2)}‚Ç¨ (-${currentDiscountPercentage}%)</div>
                `;
                discountInfoElement.classList.remove('hidden');
                cartTotal.textContent = totalAfterDiscountGlobal.toFixed(2) + '‚Ç¨';
            } else {
                totalBeforeDiscountElement.classList.add('hidden');
                discountInfoElement.classList.add('hidden');
                cartTotal.textContent = totalBeforeDiscount.toFixed(2) + '‚Ç¨';
            }
            
            finalizeBtn.disabled = currentCart.length === 0;
        }
        
        window.addCaisseItem = (name) => {
            const existing = currentCart.find(item => item.name === name);
            if (existing) {
                existing.quantity++;
            } else {
                const menuItem = menu.find(item => item.name === name.toUpperCase());
                if (menuItem) {
                    currentCart.push({ ...menuItem, quantity: 1 });
                }
            }
            updateCaisseCartDisplay();
        };

        window.removeCaisseItemQuantity = (name) => {
            const existingIndex = currentCart.findIndex(item => item.name === name);
            if (existingIndex !== -1) {
                currentCart[existingIndex].quantity--;
                if (currentCart[existingIndex].quantity <= 0) {
                    currentCart.splice(existingIndex, 1);
                }
            }
            updateCaisseCartDisplay();
        };
        
        window.clearCaisseCart = () => {
            currentCart = [];
            currentDiscountPercentage = 0;
            currentPromoCode = '';
            totalAfterDiscountGlobal = 0;
            updateCaisseCartDisplay();
            document.getElementById('caisse-client-info').innerHTML = '<div class="text-center text-gray-300">Client Anonyme</div>';
            currentClientDoc = null; 
            document.getElementById('caisse-client-telephone').value = '';
            document.getElementById('caisse-client-prenom').value = '';
            document.getElementById('caisse-client-nom').value = '';
        };

        window.searchCaisseClient = async () => {
            const tel = document.getElementById('caisse-client-telephone').value.trim();
            const infoDiv = document.getElementById('caisse-client-info');
            infoDiv.innerHTML = '<div class="text-center text-white">Recherche en cours...</div>';
            currentClientDoc = null;
            
            if (tel.length < 5) {
                infoDiv.innerHTML = '<div class="text-center text-gray-300">Client Anonyme</div>';
                document.getElementById('caisse-client-prenom').value = '';
                document.getElementById('caisse-client-nom').value = '';
                return;
            }

            try {
                const q = query(collection(db, COLLECTION_MEMBRES()), where("telephone", "==", tel));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    currentClientDoc = querySnapshot.docs[0];
                    const data = currentClientDoc.data();
                    const nextPizza = 100 - (data.points % 100);
                    infoDiv.innerHTML = `
                        <div class="text-center text-white font-bold">
                            Client trouv√©: ${data.prenom} ${data.nom}
                        </div>
                        <div class="text-sm text-gray-300 mt-1">
                            Points Fid√©lit√©: ${data.points || 0} (Prochaine pizza: ${nextPizza} pts)
                        </div>
                    `;
                    document.getElementById('caisse-client-prenom').value = data.prenom || '';
                    document.getElementById('caisse-client-nom').value = data.nom || '';
                } else {
                    infoDiv.innerHTML = '<div class="text-center text-orange-300 font-bold">Nouveau Client</div>';
                    currentClientDoc = {
                         id: 'client_non_identifie_' + Date.now(),
                         data: () => ({ nom: 'Anonyme', prenom: 'Anonyme', telephone: tel, points: 0 })
                    };
                    document.getElementById('caisse-client-prenom').value = '';
                    document.getElementById('caisse-client-nom').value = '';
                }
            } catch(e) {
                console.error("Erreur recherche client: ", e);
                infoDiv.innerHTML = '<div class="text-center text-red-500">Erreur de recherche.</div>';
            }
        };

        // --- CORRECTION FINALE ICI ---
        window.finalizeCaisseOrder = async () => {
            if (currentCart.length === 0) { showMessageModal("Erreur", "Le panier est vide."); return; }
            const confirm = await showConfirmModal("Finaliser Commande Caisse", `Confirmez la commande pour ${totalAfterDiscountGlobal.toFixed(2)}‚Ç¨ ?`);
            if (!confirm) return; 

            // IMPORTANT : On d√©finit la source sur le modal, pas sur le panier
            document.getElementById('split-payment-modal').dataset.source = 'caisse';
            
            document.getElementById('caisse-finalize-btn').disabled = true;
            window.openSplitPaymentModal(totalAfterDiscountGlobal);
        };

        window.finalizeCaissePaymentAndSave = async () => {
            const total = parseFloat(document.getElementById('split-payment-modal').dataset.total);
            const paid = currentPayments.reduce((sum, p) => sum + p.amount, 0);
            
            if (Math.abs(total - paid) > 0.01) {
                showMessageModal("Erreur", "Le total pay√© ne correspond pas au total de la commande.");
                return;
            }
            
            document.getElementById('split-payment-modal').classList.add('hidden');

            try {
                const totalAvantRemise = currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const total = totalAfterDiscountGlobal;
                const pointsGagnes = Math.floor(total);
                
                const paymentSummary = currentPayments.map(p => `${p.type}: ${p.amount.toFixed(2)}‚Ç¨`).join(' / ');
                const mainPaymentType = currentPayments.length === 1 ? currentPayments[0].type : 'Partiel';

                const clientPrenom = document.getElementById('caisse-client-prenom').value.trim() || 'Anonyme';
                const clientNom = document.getElementById('caisse-client-nom').value.trim() || '';
                const clientTel = document.getElementById('caisse-client-telephone').value.trim() || 'N/A';

                const orderData = {
                    numero_commande: `C${Math.floor(Math.random() * 90000) + 10000}`,
                    type_source: 'CAISSE',
                    type_commande: 'RETRAIT', 
                    client_id: currentClientDoc ? currentClientDoc.id : 'client_non_identifie',
                    client_nom: clientNom,
                    client_prenom: clientPrenom,
                    client_telephone: clientTel,
                    articles: currentCart.map(item => ({ 
                        name: item.name, 
                        price: item.price, 
                        quantity: item.quantity, 
                        total_ligne: item.price * item.quantity 
                    })),
                    total_avant_remise: totalAvantRemise,
                    remise_pourcentage: currentDiscountPercentage,
                    code_promo: currentPromoCode,
                    total: total,
                    statut: 'PAYEE', 
                    paiement: mainPaymentType,
                    paiements: currentPayments,
                    paiement_summary: paymentSummary,
                    date_commande: serverTimestamp(),
                    date_paiement: serverTimestamp()
                };

                const docRef = await addDoc(collection(db, COLLECTION_COMMANDES()), orderData);

                if (currentClientDoc && currentClientDoc.id !== 'client_non_identifie') {
                     await updateDoc(doc(db, COLLECTION_MEMBRES(), currentClientDoc.id), {
                         points: (currentClientDoc.data().points || 0) + pointsGagnes
                     });
                }
                
                showMessageModal("Succ√®s ‚úÖ", `Commande Caisse #${orderData.numero_commande} encaiss√©e et enregistr√©e !`);
                window.clearCaisseCart();
                document.getElementById('caisse-finalize-btn').disabled = false;
                
            } catch(e) {
                console.error("Erreur finalisation commande caisse: ", e);
                showMessageModal("Erreur ‚ùå", "Impossible d'enregistrer la commande. " + e.message);
                document.getElementById('caisse-finalize-btn').disabled = false;
            }
        };

        window.finalizeSplitPaymentForWebOrder = async (docId) => {
            const total = parseFloat(document.getElementById('split-payment-modal').dataset.total);
            const paid = currentPayments.reduce((sum, p) => sum + p.amount, 0);
            
            if (Math.abs(total - paid) > 0.01) { 
                showMessageModal("Erreur", "Le total pay√© ne correspond pas au total de la commande.");
                return;
            }
            
            document.getElementById('split-payment-modal').classList.add('hidden');
            await encaissementFinal(docId, currentPayments);
        };
        
        function getOrderPriority(order) {
            const now = Date.now();
            const dateCommande = order.date_commande.toDate().getTime();
            const timeElapsed = now - dateCommande;
            
            if (order.statut === 'EN_ATTENTE') {
                if (timeElapsed > TIME_THRESHOLDS.URGENT) return 3; 
                if (timeElapsed > TIME_THRESHOLDS.HIGH) return 2; 
                return 1; 
            }
            if (order.statut === 'EN_PREPARATION') {
                return 0; 
            }
            return -1; 
        }

        function renderOrder(c, container, showEncaissement) {
            let orderType = c.type_commande === 'LIVRAISON' ? 'üè† Livraison' : 'üèÉ Retrait';
            let orderIcon = c.type_commande === 'LIVRAISON' ? 'üöö' : 'üì¶';
            
            let cardColor = 'border-gray-300';
            let alertColor = 'bg-gray-100 text-gray-800';

            if (c.statut === 'EN_ATTENTE') {
                const priority = getOrderPriority(c);
                if (priority === 3) {
                    cardColor = 'border-red-600';
                    alertColor = 'bg-red-100 text-red-800 pulse-button';
                } else if (priority === 2) {
                    cardColor = 'border-orange-500';
                    alertColor = 'bg-orange-100 text-orange-800';
                } else {
                    cardColor = 'border-yellow-500';
                    alertColor = 'bg-yellow-100 text-yellow-800';
                }
            } else if (c.statut === 'EN_PREPARATION') {
                cardColor = 'border-indigo-600';
                alertColor = 'bg-indigo-100 text-indigo-800';
            } else if (c.statut === 'PAYEE') {
                cardColor = 'border-green-600';
                alertColor = 'bg-green-100 text-green-800';
            } else if (c.type_commande === 'LIVRAISON' && c.statut === 'EN_LIVRAISON') {
                cardColor = DELIVERY_COLOR; 
                alertColor = 'bg-blue-100 text-blue-800';
            } else if (c.type_commande === 'RETRAIT' && c.statut === 'APPEL_RETRAIT') {
                cardColor = 'border-yellow-600';
                alertColor = 'bg-yellow-100 text-yellow-800';
            }
            
            const card = document.createElement('div');
            card.className = `order-card p-6 mb-4 rounded-2xl shadow-xl slide-in border-l-8 ${cardColor}`;
            
            const articlesList = c.articles || [];
            const remiseAmount = c.remise_pourcentage ? c.total_avant_remise - c.total : 0;
            const clientName = `${c.client_prenom || ''} ${c.client_nom || ''}`;
            
            const ticketButton = `<button onclick="window.generateTicketPDF('${c.id}')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-200"> üìÑ Ticket </button>`;
            
            let actionButtons = '';
            
            if (c.type_commande === 'RETRAIT') {
                if (c.statut === 'EN_ATTENTE' || c.statut === 'EN_PREPARATION') {
                    const nextStatus = c.statut === 'EN_ATTENTE' ? 'EN_PREPARATION' : 'PRETE';
                    actionButtons = `
                        ${ticketButton}
                        <button onclick="window.updateOrderStatus('${c.id}', '${nextStatus}')" class="flex-1 bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-200 neon-glow"> 
                            ${c.statut === 'EN_ATTENTE' ? 'üî™ Pr√©parer la Commande' : 'üîî Marquer "Pr√™te"'}
                        </button>
                    `;
                    if (c.paiement === 'A_RECEPTION' && showEncaissement) {
                         actionButtons += `<button onclick="window.encaisserCommande('${c.id}', ${c.total})" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-200 neon-glow"> üí∞ Encaisser </button>`;
                    }
                } else if (c.statut === 'PAYEE') {
                    actionButtons = `
                        ${ticketButton}
                        <button onclick="window.updateOrderStatus('${c.id}', 'APPEL_RETRAIT')" class="flex-1 bg-gradient-to-r from-orange-400 to-red-500 hover:from-orange-500 hover:to-red-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-200 neon-glow"> 
                            üó£Ô∏è Chercher la Commande #${c.numero_commande}
                        </button>
                    `;
                } else if (c.statut === 'APPEL_RETRAIT') {
                    actionButtons = `
                        ${ticketButton}
                        <button disabled class="flex-1 bg-yellow-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg"> 
                            ‚ö†Ô∏è Commande #${c.numero_commande} en cours de ramassage... 
                        </button>
                    `;
                }
            } else if (c.type_commande === 'LIVRAISON') {
                if (c.statut === 'EN_PREPARATION') {
                    actionButtons = `
                        ${ticketButton}
                        <button onclick="window.updateOrderStatus('${c.id}', 'EN_LIVRAISON')" class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-200 neon-glow"> 
                            üöö Marquer "En Livraison"
                        </button>
                    `;
                } else if (c.statut === 'EN_LIVRAISON') {
                    if (c.paiement && c.paiement !== 'A_RECEPTION') {
                        actionButtons = `${ticketButton} <button disabled class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-xl font-bold">En Livraison (Pay√©e)</button>`;
                    } else {
                        actionButtons = `
                            ${ticketButton}
                            <button onclick="window.encaisserCommande('${c.id}', ${c.total})" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-200 neon-glow"> 
                                üí∞ Encaisser √† R√©ception
                            </button>
                        `;
                    }
                }
                else if (c.statut === 'PAYEE' || c.statut === 'EN_ATTENTE') {
                     actionButtons = `
                        ${ticketButton}
                        <button onclick="window.updateOrderStatus('${c.id}', 'EN_PREPARATION')" class="flex-1 bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-200 neon-glow"> 
                            üî™ Pr√©parer la Commande
                        </button>
                    `;
                }
            }
            
            if (c.type_source === 'CAISSE') {
                 actionButtons = `
                    ${ticketButton}
                    <button disabled class="flex-1 bg-gray-600 text-white py-3 px-6 rounded-xl font-bold">Commande Caisse (D√©j√† Pay√©e)</button>
                 `;
            }
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4 border-b pb-3 border-gray-200">
                    <div>
                        <h3 class="text-2xl font-black text-gray-800">${orderIcon} Commande #${c.numero_commande}</h3>
                        <p class="text-sm font-semibold text-gray-600">${orderType} | ${new Date(c.date_commande.toDate()).toLocaleString('fr-FR')}</p>
                    </div>
                    <span class="px-3 py-1 text-sm font-bold rounded-full ${alertColor}">${c.statut.replace('_', ' ')}</span>
                </div>
                <p class="font-bold text-lg text-gray-800 flex items-center mb-2">
                    <i class="text-xl mr-2">üë§</i> Client: ${clientName}
                </p>
                <p class="font-semibold text-gray-700 flex items-center mb-4">
                    <i class="text-xl mr-2">üìû</i> T√©l: ${c.client_telephone || 'N/A'}
                </p>
                ${c.type_commande === 'LIVRAISON' ? `
                    <div class="p-3 bg-red-50 border-l-4 border-red-500 rounded-lg mb-4">
                        <p class="font-semibold text-gray-700 flex items-start">
                            <i class="text-xl mr-2 mt-0.5">üè†</i> <span class="block">${c.adresse_livraison || 'Adresse non renseign√©e'}</span>
                        </p>
                    </div>
                ` : ''}
                <div class="bg-gray-100 p-4 rounded-xl mb-4">
                    <h4 class="font-bold text-lg text-gray-800 mb-2">Articles:</h4>
                    <ul class="space-y-1 text-sm">
                        ${articlesList.map(item => `
                            <li class="flex justify-between text-gray-700">
                                <span>${item.quantity}x ${item.name}</span>
                                <span>${(item.total_ligne || item.price * item.quantity).toFixed(2)}‚Ç¨</span>
                            </li>
                        `).join('')}
                    </ul>
                    ${remiseAmount > 0 ? `
                        <div class="flex justify-between text-red-600 font-semibold border-t border-red-200 pt-2 mt-2">
                            <span>Remise (${c.remise_pourcentage}%)</span>
                            <span>-${remiseAmount.toFixed(2)}‚Ç¨</span>
                        </div>
                    ` : ''}
                </div>
                <div class="flex justify-between items-center bg-gray-200 p-3 rounded-xl mb-6">
                    <span class="text-xl font-extrabold text-gray-900">Total:</span>
                    <span class="text-3xl font-black text-purple-600">${c.total.toFixed(2)}‚Ç¨</span>
                </div>
                <div class="text-sm font-semibold text-gray-600 mb-4">
                    Paiement: ${c.paiement_summary || c.paiement || 'A_RECEPTION'}
                    ${c.type_commande === 'LIVRAISON' && c.frais_livraison > 0 ? ` (+${c.frais_livraison.toFixed(2)}‚Ç¨ frais livr.)` : ''}
                </div>
                
                <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-3 mt-4">
                    ${actionButtons}
                </div>
            `;
            container.appendChild(card);
        }

        function renderCardOrder(c, container) {
            const card = document.createElement('div');
            card.className = `order-card p-6 mb-4 rounded-2xl shadow-xl slide-in border-l-8 border-purple-500`;
            const clientName = `${c.client_prenom || ''} ${c.client_nom || ''}`;
            card.innerHTML = `
                <div class="flex justify-between items-center mb-4 border-b pb-3 border-gray-200">
                    <h3 class="text-xl font-bold text-purple-600"> üí≥ Carte Cadeau #${c.numero_commande} </h3>
                    <span class="px-3 py-1 text-sm font-bold rounded-full bg-purple-100 text-purple-800">${c.statut}</span>
                </div>
                <p class="font-bold text-lg text-gray-800 flex items-center mb-2">
                    <i class="text-xl mr-2">üë§</i> Client: ${clientName}
                </p>
                <p class="font-semibold text-gray-700 flex items-center mb-4">
                    <i class="text-xl mr-2">üìû</i> T√©l: ${c.client_telephone || 'N/A'}
                </p>
                <div class="p-3 bg-yellow-50 border-l-4 border-yellow-500 rounded-lg mb-4">
                    <p class="text-lg font-bold text-gray-700 flex items-center">
                        Montant: <span class="text-2xl font-black ml-2">${c.montant.toFixed(2)}‚Ç¨</span>
                    </p>
                </div>
                <div class="flex space-x-3">
                    <button onclick="window.updateCardStatus('${c.id}', 'TRAITEE')" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-200 neon-glow"> 
                        ‚úÖ Trait√©e 
                    </button>
                    <button onclick="window.updateCardStatus('${c.id}', 'ANNULEE')" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-xl shadow-lg"> 
                        ‚ùå Annul√©e 
                    </button>
                </div>
            `;
            container.appendChild(card);
        }

        function renderAllTasks() {
            const cuisineList = document.getElementById('cuisine-list');
            cuisineList.innerHTML = '';
            
            const allTasks = [];
            commandesEnCoursMap.forEach(c => allTasks.push({ ...c, taskType: 'food' }));
            cartesEnAttenteMap.forEach(c => allTasks.push({ ...c, taskType: 'card' }));
            
            if (allTasks.length === 0) {
                 cuisineList.innerHTML = `<div class="text-center text-white opacity-60 py-8"><i class="text-6xl mb-4">üéâ</i><p>Aucune commande ou carte en attente !</p></div>`;
                 return;
            }
            
            const sortedTasks = allTasks.sort((a, b) => {
                if (a.taskType === 'card' && b.taskType === 'food') return 1;
                if (a.taskType === 'food' && b.taskType === 'card') return -1;
                
                if (a.taskType === 'food' && b.taskType === 'food') {
                    const priorityA = getOrderPriority(a);
                    const priorityB = getOrderPriority(b);
                    if (priorityA !== priorityB) return priorityB - priorityA; 
                    
                    const dateA = a.date_commande?.toDate().getTime() || 0;
                    const dateB = b.date_commande?.toDate().getTime() || 0;
                    return dateA - dateB;
                }
                
                const dateA = a.date_commande?.toDate().getTime() || 0;
                const dateB = b.date_commande?.toDate().getTime() || 0;
                return dateA - dateB;
            });
            
            const filteredTasks = sortedTasks.filter(task => {
                const searchLower = searchQuery.toLowerCase();
                if (task.taskType === 'food') {
                    return (task.client_prenom && task.client_prenom.toLowerCase().includes(searchLower)) 
                        || (task.client_nom && task.client_nom.toLowerCase().includes(searchLower)) 
                        || (task.numero_commande && task.numero_commande.toLowerCase().includes(searchLower))
                        || (task.type_commande && task.type_commande.toLowerCase().includes(searchLower))
                        || (task.statut && task.statut.toLowerCase().includes(searchLower))
                        || (task.adresse_livraison && task.adresse_livraison.toLowerCase().includes(searchLower))
                        || task.articles.some(a => a.name.toLowerCase().includes(searchLower));
                } else if (task.taskType === 'card') {
                    return (task.client_prenom && task.client_prenom.toLowerCase().includes(searchLower)) 
                        || (task.client_nom && task.client_nom.toLowerCase().includes(searchLower)) 
                        || (task.client_telephone && task.client_telephone.includes(searchLower)) 
                        || (task.numero_commande && task.numero_commande.toLowerCase().includes(searchLower));
                }
                return false;
            });

            if (filteredTasks.length === 0) {
                cuisineList.innerHTML = `<div class="text-center text-white opacity-60 py-8"><i class="text-6xl mb-4">üò¥</i><p>Aucune commande en cours ne correspond √† la recherche.</p></div>`;
                return;
            }

            filteredTasks.forEach(task => {
                if (task.taskType === 'food') {
                    renderOrder(task, cuisineList, task.type_source !== 'CAISSE');
                } else if (task.taskType === 'card') {
                    renderCardOrder(task, cuisineList);
                }
            });
        }

        window.updateCardStatus = async (docId, newStatus) => {
            const docRef = doc(db, COLLECTION_CARTES(), docId);
            const confirm = await showConfirmModal("Changement de Statut Carte", `Confirmez le passage de la carte au statut: ${newStatus}?`);
            if (confirm) {
                try {
                    await updateDoc(docRef, { statut: newStatus, date_statut_update: serverTimestamp() });
                    showMessageModal("Succ√®s ‚úÖ", `Statut de la carte mis √† jour √† ${newStatus}.`);
                } catch(e) {
                    console.error("Erreur mise √† jour statut carte: ", e);
                    showMessageModal("Erreur ‚ùå", "Impossible de mettre √† jour le statut.");
                }
            }
        };

        function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                signInAnonymously(auth)
                .then(() => {
                    document.getElementById('user-status').innerHTML = `<span class="status-indicator text-white">Connect√©</span>`;

                    const qCommandes = query(
                        collection(db, COLLECTION_COMMANDES()),
                        where("statut", "in", ["EN_ATTENTE", "EN_PREPARATION", "PRETE", "PAYEE", "APPEL_RETRAIT", "EN_LIVRAISON"])
                    );
                    
                    onSnapshot(qCommandes, (snapshot) => {
                        commandesEnCoursMap.clear();
                        snapshot.docs.forEach(doc => {
                             commandesEnCoursMap.set(doc.id, { id: doc.id, ...doc.data() });
                        });
                        renderAllTasks();
                    }, (error) => {
                        console.error("Erreur listener Commandes:", error);
                        document.getElementById('cuisine-list').innerHTML = `<div class="text-center text-red-500 py-8">Erreur de connexion aux commandes.</div>`;
                    });

                    const qCartes = query(
                        collection(db, COLLECTION_CARTES()),
                        where("statut", "==", "EN_ATTENTE")
                    );

                    onSnapshot(qCartes, snapshot => {
                        cartesEnAttenteMap.clear();
                        snapshot.docs.forEach(doc => {
                            cartesEnAttenteMap.set(doc.id, { id: doc.id, ...doc.data() });
                        });
                        renderAllTasks();
                    }, (error) => {
                        console.error("Erreur listener Cartes:", error);
                    });
                })
                .catch(error => {
                    console.error("Erreur d'authentification Firebase:", error);
                    document.getElementById('user-status').innerHTML = `<span class="text-red-500">D√©connect√©</span>`;
                });
                
                document.getElementById('search-input').oninput = (e) => {
                    searchQuery = e.target.value;
                    renderAllTasks();
                };

            } catch (e) {
                console.error("Erreur d'initialisation Firebase:", e);
                document.body.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen text-center bg-red-800 text-white p-8">
                        <div>
                            <div class="text-8xl mb-4">üõë</div>
                            <h1 class="text-4xl font-bold mb-4">Probl√®me Technique Caisse</h1>
                            <p class="text-xl mb-6">
                                L'application Caisse n'a pas pu d√©marrer. Veuillez contacter le support.
                            </p>
                            <p class="text-3xl font-black">
                                üìû 07 85 01 77 37
                            </p>
                        </div>
                    </div>
                `;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('close-modal-btn').onclick = () => document.getElementById('message-modal').classList.add('hidden');
            document.getElementById('close-ticket-btn').onclick = () => document.getElementById('ticket-modal').classList.add('hidden');

            document.getElementById('split-finalize-btn').onclick = () => {
                const orderSource = document.getElementById('split-payment-modal').dataset.source;
                const docId = document.getElementById('split-payment-modal').dataset.orderid;
                
                if (orderSource === 'caisse') {
                    window.finalizeCaissePaymentAndSave();
                } else if (orderSource === 'web_order') {
                    window.finalizeSplitPaymentForWebOrder(docId);
                }
            };
            
            const menuDiv = document.getElementById('menu-buttons');
            menu.forEach(item => {
                const button = document.createElement('button');
                button.className = 'menu-button text-white px-6 py-4 rounded-xl font-bold shadow-lg transform hover:scale-105 transition-all duration-200';
                button.innerHTML = `${item.icon} ${item.name} <span class="text-sm font-normal ml-1">(${item.price.toFixed(2)}‚Ç¨)</span>`;
                button.onclick = () => window.addCaisseItem(item.name);
                menuDiv.appendChild(button);
            });

            updateCaisseCartDisplay();
            initFirebase();
        });
    </script>
</head>
<body class="p-4 md:p-8 flex flex-col lg:flex-row space-y-8 lg:space-y-0 lg:space-x-8">

    <div class="flex-1">
        <header class="mb-6 pb-4 border-b border-white border-opacity-30 flex justify-between items-center">
            <h1 class="text-4xl font-black text-white">Zone Cuisine</h1>
            <div class="text-lg font-semibold" id="user-status">Chargement...</div>
        </header>

        <div class="flex space-x-3 mb-6">
            <input type="text" id="search-input" placeholder="Rechercher Commande/Client..." 
                   class="flex-1 p-3 border-0 rounded-xl bg-white bg-opacity-20 text-white placeholder-white placeholder-opacity-70 focus:bg-opacity-30 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 transition-all">
            <div id="opening-status" class="bg-white bg-opacity-20 text-white p-3 rounded-xl font-bold flex items-center">
                 Heures: 11h30 - 21h00
            </div>
        </div>
        
        <h2 class="text-2xl font-bold text-white mb-4">Commandes en Cours & Cartes</h2>
        <div id="cuisine-list">
            <div class="text-center text-white opacity-60 py-8"><i class="text-6xl mb-4">‚è≥</i><p>Chargement des commandes...</p></div>
        </div>
    </div>

    <div id="caisse-cart" class="lg:w-96 glass-morphism p-6 rounded-2xl shadow-2xl relative">
        <h2 class="text-3xl font-black pizza-gradient mb-6">Caisse</h2>

        <h3 class="text-xl font-bold text-white mb-4">Panier</h3>
        <ul id="caisse-cart-list" class="mb-6 space-y-2 min-h-[50px]">
            <li class="text-center text-gray-300">Panier vide.</li>
        </ul>

        <div id="caisse-discount-info" class="mb-4 hidden"></div>

        <div class="flex justify-between items-center py-3 border-t border-b border-white border-opacity-30">
            <span class="text-xl font-bold text-white">Total (avant remise):</span>
            <span id="caisse-total-before-discount" class="text-xl font-bold text-gray-300 line-through hidden">0.00‚Ç¨</span>
        </div>
        <div class="flex justify-between items-center py-3 mb-4">
            <span class="text-2xl font-black text-white">Total √† Payer:</span>
            <span id="caisse-cart-total" class="text-3xl font-black text-white">0.00‚Ç¨</span>
        </div>
        
        <button onclick="window.clearCaisseCart()" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-xl shadow-lg transition-all mb-4">
            ‚ùå Vider le Panier
        </button>

        <h3 class="text-xl font-bold text-white mb-4 mt-6">Menu Rapide</h3>
        <div id="menu-buttons" class="grid grid-cols-2 gap-3 mb-6">
        </div>

        <h3 class="text-xl font-bold text-white mb-4 mt-6">Informations Client</h3>
        <div class="flex space-x-3 mb-4">
            <input type="text" id="caisse-client-telephone" placeholder="T√©l. Client (Recherche)" 
                   class="flex-1 p-3 border-0 rounded-xl bg-white bg-opacity-20 text-white placeholder-white placeholder-opacity-70 focus:bg-opacity-30 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 transition-all">
            <button onclick="window.searchCaisseClient()" class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transform hover:scale-105 transition-all">
                üîç
            </button>
        </div>
        <div id="caisse-client-info" class="mb-4 min-h-[50px] text-center text-gray-300">Client Anonyme</div>
        
        <div class="grid grid-cols-2 gap-3 mb-4">
            <input type="text" id="caisse-client-prenom" placeholder="Pr√©nom (si nouveau)" 
                   class="p-3 border-0 rounded-xl bg-white bg-opacity-20 text-white placeholder-white placeholder-opacity-70 focus:bg-opacity-30 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 transition-all">
            <input type="text" id="caisse-client-nom" placeholder="Nom (si nouveau)" 
                   class="p-3 border-0 rounded-xl bg-white bg-opacity-20 text-white placeholder-white placeholder-opacity-70 focus:bg-opacity-30 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 transition-all">
        </div>

        <h3 class="text-xl font-bold text-white mb-4 mt-6">Code Promo</h3>
        <div class="flex space-x-3 mb-4">
            <input type="text" id="promo-code-input" placeholder="Entrer un code promo" 
                   class="flex-1 p-3 border-0 rounded-xl bg-white bg-opacity-20 text-white placeholder-white placeholder-opacity-70 focus:bg-opacity-30 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 transition-all">
            <button onclick="handlePromoCode()" class="bg-gradient-to-r from-pink-500 to-rose-600 text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transform hover:scale-105 transition-all">
                Appliquer
            </button>
        </div>

        <button onclick="window.finalizeCaisseOrder()" id="caisse-finalize-btn" disabled
                class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-4 rounded-xl shadow-2xl mt-4 transform hover:scale-105 transition-all duration-300 pulse-button">
            üí∞ Finaliser & Payer
        </button>
    </div>

    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="glass-morphism rounded-2xl shadow-2xl w-full max-w-sm m-4">
            <div class="bg-gradient-to-r from-purple-500 to-pink-600 p-4 text-white font-bold rounded-t-2xl">Notification</div>
            <div class="p-6 text-center">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4">Titre</h3>
                <p id="modal-message" class="text-gray-600 mb-6">Message</p>
                <button id="close-modal-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-6 rounded-xl transition-all">Fermer</button>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="glass-morphism rounded-2xl shadow-2xl w-full max-w-sm m-4">
            <div class="bg-gradient-to-r from-orange-500 to-red-600 p-4 text-white font-bold rounded-t-2xl">Confirmer l'Action</div>
            <div class="p-6 text-center">
                <h3 id="confirm-title" class="text-xl font-bold text-gray-800 mb-4">Titre</h3>
                <p id="confirm-message" class="text-gray-600 mb-6">Message</p>
                <div class="flex justify-center space-x-4">
                    <button id="confirm-no-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-xl transition-all">Annuler</button>
                    <button id="confirm-yes-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-xl transition-all">Confirmer</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center hidden">
        <div class="glass-morphism rounded-2xl shadow-2xl w-full max-w-sm m-4">
            <div id="payment-title" class="bg-gradient-to-r from-blue-600 to-purple-600 p-4 text-white font-bold rounded-t-2xl">Paiement</div>
            <div id="payment-content" class="p-6"> 
            </div>
        </div>
    </div>

    <div id="split-payment-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[50] flex items-center justify-center hidden" data-total="0.00" data-source="" data-orderid="">
        <div class="glass-dark rounded-2xl shadow-2xl w-full max-w-md m-4">
            <div class="bg-gradient-to-r from-purple-500 to-indigo-600 p-4 text-white font-bold rounded-t-2xl">Paiement Fractionn√©</div>
            <div class="p-6">
                <div class="text-center mb-6 p-4 rounded-xl border border-white border-opacity-30 bg-white bg-opacity-10">
                    <div class="text-lg font-bold text-white mb-2">Total de la commande: <span id="split-total-amount" class="text-3xl font-black ml-1">0.00‚Ç¨</span></div>
                    <div class="text-lg font-bold text-white">Reste √† payer: <span id="split-remaining-amount" class="text-3xl font-black ml-1 text-red-500">0.00‚Ç¨</span></div>
                </div>
                
                <ul id="split-payments-list" class="mb-6 space-y-2 max-h-40 overflow-y-auto pr-2">
                </ul>
                
                <h4 class="text-white font-bold mb-3">Ajouter un paiement</h4>
                <div class="flex space-x-3 mb-4">
                    <select id="split-payment-type" class="p-3 border-0 rounded-xl bg-white bg-opacity-20 text-white focus:ring-2 focus:ring-white focus:ring-opacity-50 transition-all flex-1">
                        <option value="Especes" class="bg-gray-700">üíµ Esp√®ces</option>
                        <option value="Carte" class="bg-gray-700">üí≥ Carte</option>
                        <option value="TicketResto" class="bg-gray-700">üé´ Ticket Resto</option>
                    </select>
                    <input type="number" id="split-payment-amount" step="0.01" placeholder="Montant" 
                           class="w-24 p-3 border-0 rounded-xl bg-white bg-opacity-20 text-white placeholder-white placeholder-opacity-70 focus:bg-opacity-30 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 transition-all text-right">
                    <button onclick="window.addSplitPayment()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-xl font-bold transition-all">
                        +
                    </button>
                </div>
                
                <button id="split-finalize-btn" disabled
                        class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-bold py-3 rounded-xl shadow-lg mt-4 disabled:bg-gray-500 disabled:from-gray-500 disabled:to-gray-500">
                    ‚úÖ Finaliser l'Encaissement
                </button>
                <button onclick="window.closeSplitPaymentModal()" class="w-full mt-3 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 rounded-xl transition-all">Annuler le paiement</button>
            </div>
        </div>
    </div>
    
    <div id="ticket-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="glass-morphism rounded-2xl shadow-2xl w-full max-w-sm m-4">
            <div class="bg-gradient-to-r from-purple-500 to-pink-600 p-4 text-white font-bold rounded-t-2xl flex justify-between items-center">
                <span>üé´ Ticket de Caisse (<span id="qrcode-numero">#N/A</span>)</span><button id="close-ticket-btn" class="text-white hover:text-gray-200">‚úï</button>
            </div>
            <div class="p-6 text-center">
                <pre id="ticket-details" class="mb-6 bg-gray-100 p-4 rounded-xl text-left text-sm whitespace-pre-wrap"></pre>
                <div class="bg-white p-4 rounded-xl inline-block"><img id="ticket-qr-image" src="" alt="QR Code Ticket" class="w-32 h-32"/></div>
                <p class="text-sm text-gray-600 mt-2 mb-4">Ce QR Code contient les d√©tails du ticket.</p>
                <button onclick="window.downloadTicket()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-xl transition-all">T√©l√©charger le TXT</button>
            </div>
        </div>
    </div>
</body>
</html>